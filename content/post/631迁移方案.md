+++
data = '2025-08-05T11:02:00+08:00'
draft = 'true'
title = '631迁移方案'
+++

### 目录

开始迁移前可在旧环境创建一些带有时间标识的数据，方便迁移后验证是否迁移成功

旧环境：

1. 备份安装介质
2. 停服务
3. 备份mysql
4. 备份mongodb
5. 定开备份

新环境

1. 初始化蓝鲸平台
2. 迁移环境变量
3. 部署蓝鲸平台
4. 部署devops
5. 验证功能正常后停服
6. 备份新平台数据
7. 迁移mysql
8. 迁移MongoDB
9. 拉起服务

恢复后处理

### 旧环境

#### 1.备份安装介质

```bash
# 中控机
1. 备份 install
tar cvf installold.tar /data/install

2. 备份 src
tar cvf srcold.tar /data/src
```

#### 2.停服务

```bash
# 停掉除了mysql，mongod之外的全部服务
下架官方 SaaS，访问蓝鲸 PaaS 平台，通过【开发者中心】->【 S-mart 应用】下架所有官方 SaaS

echo nginx paas_plugins bklog bknodeman bkmonitorv3 job bkiam bkssm usermgr cmdb paas appo appt gse license influxdb redis  kafka zk es7 rabbitmq consul redis_sentinel | xargs -n 1 /data/install/bkcli stop

echo nginx paas_plugins bklog bknodeman bkmonitorv3 job bkiam bkssm usermgr cmdb paas appo appt gse license influxdb redis  kafka zk es7 rabbitmq consul redis_sentinel | xargs -n 1 /data/install/bkcli status

pcmd -m appo systemctl stop docker
systemctl stop bk-ci.target
# pcmd -m appt systemctl stop docker   （如有对应服务停掉）

./bkcli status all

# 根据情况，可以清理一下执行记录、日志、告警等表

--- 查看各个数据库的大小 ---
select
table_schema as '数据库',
sum(table_rows) as '记录数', sum(truncate(data_length/1024/1024/1024, 2)) as '数据容量(GB)', sum(truncate(index_length/1024/1024/1024, 2)) as '索引容量(GB)' from information_schema.tables
group by table_schema
order by sum(data_length) desc, sum(index_length) desc;

--- 查看某个数据库下面各个表大小 --- 
select
table_schema as '数据库',
table_name as '表名',
table_rows as '记录数',
truncate(data_length/1024/1024, 2) as '数据容量(MB)',
truncate(index_length/1024/1024, 2) as '索引容量(MB)'
from information_schema.tables
where table_schema='job_execute'
order by data_length desc, index_length desc;
```

#### 3.备份mysql

```bash
# 1.创建备份目录
mkdir -p /data/dbbak_$(date +%F)/mysql
cd /data/dbbak_$(date +%F)/mysql

# 2.备份数据库(注意：是否有拆分数据库部署场景)
source /data/install/utils.fc
#"bkdata_monitor_alert"监控告警库是否备份请自行评估。
mysql --login-path=default-root -e "show databases;" |grep -Ewv "Database|information_schema|performance_schema|mysql|sys|bksuite_common|*_bkt|test" > /tmp/databases;


for name in `cat /tmp/databases` ;do echo $name ; mysqldump --login-path=default-root --skip-opt --create-options --default-character-set=utf8mb4 -R  -E -q -e --single-transaction --no-autocommit --master-data=2 --max-allowed-packet=1G  --hex-blob --databases $name > /data/dbbak_$(date +%F)/mysql/$name.sql ;done

# 3.检查导出 sql 文件，确认无误后打包(建议不打包直接传输减少耗时)
```

#### 4.备份mongodb

```bash
# 1.登陆至 MongoDB 机器，创建备份目录
source /data/install/utils.fc
mkdir -p /data/dbbak_$(date +%F)/mongodb

# 2.开始备份 MongoDB
source /data/install/utils.fc
# 备份 MongoDB 数据：
# 可先登录mongodb查看有哪些数据库
mongodump --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --authenticationDatabase admin --archive=/data/dbbak_$(date +%F)/mongodb/cmdb.gz --gzip --db db_devops_ci_ctest

# mongodump --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --authenticationDatabase admin --archive=/data/dbbak_$(date +%F)/mongodb/cmdb.gz --gzip --db cmdb

# mongodump --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --authenticationDatabase admin --archive=/data/dbbak_$(date +%F)/mongodb/gse.gz --gzip --db gse
```

#### 5.定开备份

```bash
# 备份ad登陆【如存在】
source /data/install/utils.fc
cd /data/install
pcmd -m paas "mkdir -p /data/confbak_$(date +%F)"
pcmd -m paas "cp -a /data/bkee/open_paas/login/ee_login /data/confbak_$(date +%F)"
pcmd -m paas "cp -a /home/bkee/open_paas{,_bak$(date +%F)}"
#检查是否备份成功
pcmd -m paas "ls /data/confbak_$(date +%F)"

# 备份微信配置【如存在】
source /data/install/utils.fc
cd /data/install
ssh $BK_PASS_IP
cp -a /data/bkee/etc/uwsgi-open_paas-esb.ini  /data/confbak_$(date +%F)/
```

### 新环境

#### 1.初始化蓝鲸平台

1. 根据调研信息填写excel

2. 解压

   - 把基础平台包(cwbkee_product-xxxxx.tar.gz)全部放在安装目录（默认为/data)，包含监控、日志包(我的包名为嘉为蓝鲸4.0测试-Jackliang-20231221192656.tar.gz)
   - 解压cwbkee_product.xxxxxxx.tar.gz到/data
   - mv /data/src/cwbk_install-xxx.tar.gz /data/
   - tar xvf cwbk_install-xxx.tar.gz -C /data
   - 上传表格到/data/cwbk_install/，删除旧表格
   - rm 2RP01.01_蓝鲸平台-部署前环境信息调研表-20240319.xlsx
   - 如果表格有误，可以重新上传，并删除/data/cwbk_install/.run中的conv2txt，init_install_cfg

3. 初始化
   ```bash
   cd /data/cwbk_install
   
   ./cwbk_install -init
   ```

#### 2.迁移环境变量

```bash
1.初始化结束后进行install的处理，把旧环境的/data/install/bin/*拷贝到新环境

***注意***
此处环境变量有几处需要修改
cd /data/bin/install/bin/【01-05】
grep "10.11.27.***(旧环境ip地址)" *.env 
这几个文件里面有旧环境的ip的env文件需要删除，否则会导致后面部署devops平台采用旧环境ip变量，无法访问
***注意***

2./root/.tag 处理，把旧环境的中控机/root/.tag/*拷贝到新环境，加锁chattr +i *，/root/.tag 是标记文件，如果存在./bkcli install bkenv就不会刷新变量
```

#### 3.部署蓝鲸平台

```bash
# 中控机执行
cd /data/install
# 初始化环境
./bk_install common
# 校验环境和部署的配置
./health_check/check_bk_controller.sh

# 检查/data/install/bin/【01-05】下文件的时间戳有没有变化，抽查一下环境变量有没有变化。符合预期再往下进行

# 部署 PaaS 平台
./bk_install paas
# 部署 SaaS 运行环境，正式环境及测试环境
./bk_install app_mgr

# 部署用户管理和权限中心saas
./bk_install saas-o bk_iam
./bk_install saas-o bk_user_manage
```

#### 4.部署devops

1. 准备部署文件

   - 部署脚本包
   - images/centos.gz ccheck-images.gz ctest-images.gz onlyoffice.gz bkrepo-dependency-check.gz bkrepo-trivy.gz cflow-image.gz
   - pkgs/ software.zip db.tar.gz javadb.tar.gz dependency-check-db.tar.gz apache-pulsar-2.10.6-bin.tar.gz pulsar-io-rabbitmq-2.10.6.nar apache-doris-2.1.7-fe-bin-x64-noavx2.tgz apache-doris-2.1.7-be-bin-x64-noavx2.tgz kotlin-compiler-1.8.10-canway.zip **cert.gw**
   - prd/CTest-6.0.x.tar.gz CTeam-6.0.x.tar.gz CComm-6.0.x.tar.gz

2. 解压脚本
   ```bash
   tar -xf bkci_inst_v4.3.x.tar.gz -C /data
   ```

3. 填写环境变量
   ```bash
   vim env.properties
   ```

4. 执行脚本
   ```bash
   cd $CTRL_DIR
   ./bkcli install es7
   ./bkcli start es7 && ./bkcli status es7
   ./bkcli install influxdb
   ./bkcli start influxdb && ./bkcli status influxdb
   
   cd /data/bkci_inst
   ./devops_install.sh | tee `date +%Y-%m-%d_%H:%M:%S`.log
   ```

#### 5.验证功能正常后停服

```bash
# 停服务
下架官方 SaaS，访问蓝鲸 PaaS 平台，通过【开发者中心】->【 S-mart 应用】下架所有官方 SaaS

echo nginx bknodeman bkmonitorv3 job bkiam bkssm usermgr cmdb paas appo appt gse license influxdb redis  kafka zk es7 rabbitmq consul redis_sentinel | xargs -n 1 /data/install/bkcli stop

echo nginx bknodeman bkmonitorv3 job bkiam bkssm usermgr cmdb paas appo appt gse license influxdb redis  kafka zk es7 rabbitmq consul redis_sentinel | xargs -n 1 /data/install/bkcli status

pcmd -m appo systemctl stop docker
systemctl stop bk-ci.target
# pcmd -m appt systemctl stop docker   （如有对应服务停掉）

./bkcli status all
```

#### 6.备份新平台数据

```bash
# 备份 mysql
mkdir -p /data/dbbak_$(date +%F)/mysql
ALL_DBS=$(mysql --login-path=default-root -e "show databases;"|grep -Ewv Database)

for i in ${ALL_DBS[@]}; do mysqldump --login-path=default-root --skip-opt --create-options --default-character-set=utf8mb4 -R  -E -q -e --single-transaction --no-autocommit --master-data=2 --max-allowed-packet=1G  --hex-blob --databases $i > /data/dbbak_$(date +%F)/mysql/$i.sql;done

# 请检查导出是否正确
grep 'CREATE DATABASE' bk_mysql_alldata.sql

# 备份 mongodb
# MongoDB 机器上执行

source /data/install/utils.fc
ssh $BK_MONGODB_IP
mkdir -p /data/dbbak_$(date +%F)/mongod
source /data/install/utils.fc
mongodump --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --oplog --gzip --out /data/dbbak_$(date +%F)/mongod

# 备份 install
# 中控机执行
cp -a -r /data/install /data/install_$(date +%Y%m%d%H%M)
```

#### 7.迁移 mysql

```bash
# 创建/data/dbbak/mysqlold，将旧环境的数据传过来
mkdir -p /data/dbbak/mysqlold

# 删除 mysql，注意cwlicense 等特有库

ALL_DBS=$(mysql --login-path=default-root -e "show databases;" | egrep -v "Database|information_schema|performance_schema|mysql|sys|bksuite_common")
# 如果需要装双agent则不需要导入bknodeman,bk_nodeman(可在ALL_DBS过滤)
echo ${ALL_DBS[@]}

for i in ${ALL_DBS[@]};do mysql --login-path=default-root -e "drop database $i";done

# 遇到cc-auto 等库名，可以用下面语句处理
for i in ${ALL_DBS[@]};do mysql --login-path=default-root -e "drop database \`$i\`";done

# 导入 mysql
for i in /data/dbbak/mysqlold/*.sql;do mysql --login-path=default-root < "$i";done
# 如果客户端有超时限制，可以放到后台跑
nohup sh -c 'for i in /data/dbbak/mysqlold/*.sql; do mysql --login-path=default-root < "$i"; done' &

# 保持监控
while true; do date; ps -ef | grep '[m]ysql_old' | tee -a /tmp/mysql.log; sleep 60; done
```

#### 8.迁移 mongodb

```bash
# 迁移数据前需要创建目录/data/dbbak/mongodbold/，将旧环境的数据传过来
mkdir -p /data/dbbak/mongodbold/  

mongorestore  --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --authenticationDatabase admin -d gse --drop --gzip --archive=/data/dbbak/mongodbold/db_devops_ci_ctest.gz

# mongorestore  --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --authenticationDatabase admin -d gse --drop --gzip --archive=/data/dbbak/mongodbold/gse.gz
# 如果需要装双agent则不需要导入cmdb
# mongorestore  --host $BK_MONGODB_IP -u $BK_MONGODB_ADMIN_USER -p $BK_MONGODB_ADMIN_PASSWORD --authenticationDatabase admin -d cmdb --drop --gzip --archive=/data/dbbak/mongodbold/cmdb.gz
```

#### 9.拉起服务

```bash
# 数据迁移后数据库里的app_secret变为旧环境的app_secret,但新环境里是新生成的app_secret,此时前后端app_secret不匹配导致无法访问
# 更改新环境app_secret,gateway所在服务器
vim /data/bkee/ci/gateway/lua/init.lua

# 修改内容如下：
# cat 旧环境的/data/bkee/ci/gateway/lua/init.lua | grep -A 10 oauth 将app_secret复制粘贴过

oauth = { -- 对接蓝鲸权限中心才需要的配置
        ip = "10.11.27.174",
        env = "prod",
        port = "5000",
        host = "bkssm.service.consul",
        url = "/api/v1/auth/access-tokens", -- 接口路径
        app_code = "bk_ci",
        app_secret = "981ccb3c-63ed-4a10-b60f-0daefba5d92a"  # 改为旧环境的app_secret
    },
    
systemctl restart bk-ci-gateway.service

# 启动服务以及后续处理
echo nginx bknodeman bkmonitorv3 job bkiam bkssm usermgr cmdb paas appo appt gse license influxdb redis  kafka zk es7 rabbitmq consul redis_sentinel | xargs -n 1 /data/install/bkcli start
systemctl start bk-ci.service
```

### 恢复后处理

1. vteam未注册consul服务
   ```bash
   vim /data/bkee/ci/vteam/BOOT-INF/classes/application-bklatest.yml
   
   # 修改内容如下：
    cloud:
       consul:
         # host: 192.168.104.81
         # Consul 服务器地址（填写实际运行 Consul 的节点 IP，如 10.11.27.175）
         host: 10.11.27.175
         # Consul 服务端口（默认 8500）
         port: 53
         discovery:
           # 服务名（必须为 vteam-devops，与 DNS 解析的服务名匹配）
           serviceName: vteam-devops
           # 服务标签（必须包含 devops，与 DNS 解析的 devops. 前缀匹配）
           tags: devops
           # 启用服务注册（必须设为 true）
           register: true
           # 注册时使用服务所在节点的实际 IP（10.11.27.171）
           preferIpAddress: true
           # 服务端口（若未指定，默认使用应用启动端口，如 8080，确保端口未被占用）
           port: 8080
           
   systemctl restart bk-ci-vteam.service
   ```

2. 登录异常
   ```bash
   # 报错
   APP Secret verification failed, pelase confirm if the APP Secret and APP Code [bk_app_code=bk_paas] match
   
   # 处理方法一
   grep -nri APP_SECRET /data/install/bin
   bkapigw.env:2:BK_APIGW_APP_SECRET=f7e2a775-c9c6-4577-9a1a-42f7487744f7
   ...
   
   更新：app_token为原来的
   use open_paas;
   
   update  esb_app_account set app_token='cd740dec-5d34-4c60-8952-429f2f08ab1e' where app_code='bk_paas';
   ...
   
   # 处理方法二
   恢复表 open_paas.esb_app_account
   ```

3. 开发者中心注册的appo服务器信息不对，需要重新激活
   ```bash
   # 方法一
   # 从备份新平台备份数据找到 engine_servers 表记录数据。
   mysql>use open_paas
   mysql>delete from engine_hosting_ships where bk_server_id>0;
   mysql>delete from engine_servers where id >0;
   ## 如下数据来源于备份新平台备份engine_servers表数据，可以从备份sql文件提取。
   mysql>INSERT INTO `engine_servers` VALUES (1,'','a2f127ec19e741e48c3eb1a3f3d8138b','39aba83ca52b4639bf525a18b764fea6','10.11.24.146','4245','app','',1,'2023-08-25 13:01:08.932744','2023-08-25 13:01:12.489231','8010','28:6E:D4:8A:17:1C');
   
   
   # 方法二
   1、从开发者中心添加新的服务器信息，生成新的服务器ID和Token
   2、修改appo 机器 /data/bkee/etc/paas_agent_config.yaml ，填写新的信息
   3、重启 appo，页面点击激活
   ```

4. 激活失败
   ```bash
   # 问题
   /data/bkee/logs/paasagent/agent.log提示
   1305102 sid or token is not valid, please check
   
   # 处理
   /data/bkee/etc/paas_agent_config.yaml 检查是否一致，删除并重新生成 、激活
   没有可用./bkcli install appo
   
   pcmd -m appo "systemctl restart bk-paasagent"
   ```

5. 若有SAAS打开异常，请尝试重新部署，部署请检查环境变量，如ITSM、日志平台的REDIS配置IP是否准确
   ```bash
   mysql>use open_paas
   mysql>delete from paas_app_envvars;
   ## 如下数据来源于备份新平台备份paas_app_envvars表数据,可以从备份sql文件提取。
   mysql> INSERT INTO `paas_app_envvars` VALUES (3,'bk_nodeman','all','BKAPP_GSE_SERVER_WAN_IPLIST','10.11.24.146','Update by install script'),
   (109,'bk_monitorv3','all','BKAPP_ENABLE_SHARED_FS','b\'1\'','set by S-mart App');
   ```

6. 检查外链应用是否正确
   ```bash
   开发者中心 -> 外链应用 -> 修改所有外链应用 [基本信息] 栏中的 [系统链接] 为自身环境正确的地址，保存即可
   
   #检查域名是否与新平台一致
   mysql>use open_paas
   mysql>select code, external_url from paas_app where code in ('bk_job', 'bk_cmdb');
   +---------+--------------------------+
   | code    | external_url             |
   +---------+--------------------------+
   | bk_cmdb | http://cmdb.bkee4.com:80 |
   | bk_job  | http://job.bkee4.com:80  |
   +---------+--------------------------+
   2 rows in set (0.00 sec)
   
   ## 如不一致，需要修改。
   ## job 
   mysql>update paas_app set external_url="xxxxx" where code='bk_job'
   
   ## cmdb
   mysql>update paas_app set external_url="xxxxx" where code='bk_cmdb'
   ```

7. 如果有监控，重新部署，修改influxdb
   ```bash
   # 更新influxdb ip
   # bkmonitorv3_alert.metadata_influxdbhostinfo
   
   mysql>use bkmonitorv3_alert;
   mysql>delete from metadata_influxdbclusterinfo;
   mysql>delete from metadata_influxdbhostinfo;
   mysql>delete from metadata_clusterinfo;
   ## 如下数据来源于备份新平台备份metadata_influxdbhostinfo表数据,可以从备份sql文件提取。
   mysql>INSERT INTO `metadata_influxdbhostinfo` VALUES ('INFLUXDB_IP0','10.11.24.148',8086,'admin','aes_str:::LrBZ5bXwhS/f6RKHWGz3ZGpFAr12hKYoI6zJ3ejTJiQ=','system auto add.');
   ```

8. 两套环境rabbitmq admin密码不一样，需要修改
   ```bash
   密码 echo $BK_RABBITMQ_ADMIN_PASSWORD
   
   mysql>update engine_third_servers set server_info='{"ip_address": "rabbitmq.service.consul", "ip_port": "15672", "username": "admin", "password": "sUu7bZuxU8S2"}';
   ```

9. 清理cmdb的topo数据
   ```bash
   # 清理旧的topo数据
   # 登录 MongoDB
   mongo \
   	-u $BK_CMDB_MONGODB_USERNAME \
   	-p $BK_CMDB_MONGODB_PASSWORD \
       mongodb://$LAN_IP:$BK_CMDB_MONGODB_PORT/cmdb \
       --authenticationDatabase cmdb
   
   # 执行清理
   db.cc_ServiceTemplate.remove({"bk_biz_id":2})	
   db.cc_ProcessTemplate.remove({"bk_biz_id":2})
   db.cc_SetTemplate.remove({"bk_biz_id":2})
   db.cc_SetBase.remove(
   	{$and:[
   		{"bk_set_id":{$gt:2}},
   		{"bk_biz_id":{$eq:2}}
   	]},
   	{"bk_set_id":1,"bk_set_name":1,"bk_biz_id":1,"bk_biz_name":1}
   );
   ```

10. admin 登录不上，提示密码不对
    ```bash
    # 修改admin密码
    workon usermgr-api
    export DJANGO_SETTINGS_MODULE="bkuser_core.config.overlays.prod"
    export BK_FILE_PATH=${INSTALL_PATH}/usermgr/cert/saas_priv.txt
    python manage.py shell
    from bkuser_core.profiles.models import Profile
    from django.contrib.auth.hashers import make_password
    admin = Profile.objects.get(username='admin', domain='default.local')
    admin.password = make_password("blueking")  
    admin.save()
    
    # 修改默认登录域
    bk_user.categories_profilecategory
    ```

    

