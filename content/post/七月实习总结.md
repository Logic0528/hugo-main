+++ date = '2025-07-31T14:49:19+08:00' draft = true title = '七月实习总结'
### 一.命令类

```bash
yum install lrzsz
rz  #上传文件，500M以下

#远程文件同步
rsync -avz -e ssh /path/to/source/ user@remote:/path/to/destination/
# -a 归档模式，递归并保留文件属性
# -v 详细输出模式
# -z 传输时压缩文件数据

find /path -name "filename"

#vim
:1,100yank  #复制第一到第一百行内容
:100   #跳转至第一百行
:%d  #删除全部
:5,10d

sed -i 's/old/new/g' file.txt

kubectl -n spline expose deployment front-end --type=NodePort -port=80 --target-port=80 --name=front-end-svc
# kubectl expose 和 kubectl create service都能创建service，expose专门用于 “为已有工作负载（如 Deployment、Pod、ReplicaSet 等）自动创建 Service”
```

### 二.问题类

```bash
/data/bkci_inst/script/ci.env  #环境变量

/data/bkee/logs/ci/    #日志
```

#### 1.mongodb未安装，导致脚本后续用户创建失败认证失败等一系列问题

```bash
# 安装 MongoDB
sudo rpm -ivh /data/myhttpd/data/cw_yum_3.0/mongodb-org-server-4.4.15-1.el8.x86_64.rpm
sudo rpm -ivh /data/myhttpd/data/cw_yum_3.0/mongodb-org-shell-4.4.15-1.el8.x86_64.rpm
sudo rpm -ivh /data/myhttpd/data/cw_yum_3.0/mongodb-database-tools-rhel70-x86_64-100.10.0.rpm

# 编辑配置文件
sudo vim /etc/mongod.conf

# bindIp: 0.0.0.0
# 找到并注释掉认证配置
# security:
# authorization: enabled  # 注释这两行，临时关闭认证

# 重启 MongoDB 服务
sudo systemctl start mongod

# 查看变量里存储的密码，用户名一般就是root,下面进行手动创建用户
echo $BK_MONGODB_ADMIN_PASSWORD

# 无密码连接 MongoDB（此时关闭了认证）
mongo mongodb://10.11.27.174:27017/admin

// 切换到 admin 数据库（管理员用户必须创建在 admin 库）
use admin

// 创建 root 用户，密码使用环境变量中的 JYMFo_iY9zBj
db.createUser({
  user: "root",  // 与 BK_MONGODB_ADMIN_USER 一致
  pwd: "JYMFo_iY9zBj",  // 与 BK_MONGODB_ADMIN_PASSWORD 一致
  roles: [{ role: "root", db: "admin" }]  // 授予最高权限（确保能创建其他用户）
})

// 验证用户是否创建成功
db.getUser("root")  // 应输出用户信息，确认密码哈希值存在

// 退出终端
exit
```

#### 2.yum源相关问题

- yum源安装失败

```bash
cat /etc/sysconfig/myhttpd.yaml
#看端口是否是8070
baseurl= ip:8070///文件路径
#修改后重启myhttpd服务
```

- 非中控机无法通过网络访问中控机yum源

```bash
cat /etc/yum.repo/cwyum.repo
# 查看是否IP地址后是否有8070端口，该路径下全部repo文件都需要改
```

- 缺少yum源，可能是缺少麒麟的yum源

```bash
cd /etc/yum.repo/
ls
# 有个bak文件夹里面有麒麟的yum源，mv ky.repo ../

yum clean all
yum makecache
```

#### 3.pulsar脚本访问java路径不存在
路径不存在或是后面的mysql等服务没起来，原因可能是文件路径与脚本不匹配导致的

```bash
# 正确设置 JAVA_HOME
# 获取 JAVA_HOME 的正确值
readlink -f $(which java) | sed "s:bin/java::"

# 更新环境变量
sudo vi /etc/profile.d/java.sh
# 根据实际输出结果修改下面的路径
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.261.b12-1.el7_7.x86_64/
export PATH=$JAVA_HOME/bin:$PATH
# 刷新环境变量
source /etc/profile.d/java.sh
```

该问题后续会导致link_pulsar_to_mq租户不存在

```bash
cd /data/apache-pulsar-2.10.6
bin/pulsar-admin tenants create cpack

bin/pulsar-admin namespaces create cpack/bkrepo

# 查看所有租户
bin/pulsar-admin tenants list

# 查看 cpack 租户下的命名空间
bin/pulsar-admin namespaces list cpack
```

#### 4.cousul无法访问
缺少client_addr,默认值为127.0.0.1，即仅允许本地访问8500端口，导致应用通过10.11.26.166：8500访问时被拒绝

```bash
# 编辑配置文件
vi /etc/consul.d/consul.json

{
    "client_addr": "0.0.0.0",  // 新增此行，允许所有接口访问 HTTP 接口
    "bind_addr": "10.11.26.166",
    ...
}
```

#### 5.mongodb,redis,mysql,zookeeper等服务启动失败
很大概率是因为目录权限问题，或者是你在重启机器后发现原来正常的mysql启动不起来了
正确属组应该是mysql:mysql而不是blueking:blueking

```bash
# 查看当前配置文件权限
ls -l /etc/redis/sentinel-default.conf

# 设置权限：允许 redis 用户读写配置文件
sudo chown redis:redis /etc/redis/sentinel-default.conf
sudo chmod 644 /etc/redis/sentinel-default.conf  # 确保可读可写

# 确认权限已生效
ls -l /etc/redis/sentinel-default.conf
# 输出应显示：-rw-r--r-- 1 redis redis ...
```

#### 6.Mongodb从节点加入不了集群

```bash
Client view of cluster state is {type=REPLICA_SET, servers=[]}

> rs.status0
“ok” : 0,
"errmsg":"not running with --replSet",
"code" : 76,
"codeName" : "NoReplicationEnabled"
>
```

```bash
# 修改配置文件(通常为/etc/mongod.conf)：

replication:
replSetName："你的副本集名称" # 例如：rs0

# 用管理员账号登录MongoDB
mongo --host 10.11.27.172 -u root -p JYMFo_iY9zBj -authenticationDatabase admin
# 初始化副本集（单节点配置）
rs.initiate({
_id："你的副本集名称"，
members:[
｛_id: 0,host: "10.11.27.172:27017"}
]

#修改应用配置，添加replicaSet参数:

spring:
data:
	mongodb:
		uri：mongodb://root:JYMFo_iY9zBj@10.11.27.172:27017/你的数据库名?replicaSet=你的副本集名称
```



#### 7.安装es7失败

```bash
# 删除无效插件目录
sudo rm -rf /usr/share/elasticsearch/plugins/elasticsearch-analysis-ik-
```

#### 8.vteam未注册consul服务

```bash
vim /data/bkee/ci/vteam/BOOT-INF/classes/application-bklatest.yml

# 修改内容如下：
 cloud:
    consul:
      # host: 192.168.104.81
      # Consul 服务器地址（填写实际运行 Consul 的节点 IP，如 10.11.27.175）
      host: 10.11.27.175
      # Consul 服务端口（默认 8500）
      port: 53
      discovery:
        # 服务名（必须为 vteam-devops，与 DNS 解析的服务名匹配）
        serviceName: vteam-devops
        # 服务标签（必须包含 devops，与 DNS 解析的 devops. 前缀匹配）
        tags: devops
        # 启用服务注册（必须设为 true）
        register: true
        # 注册时使用服务所在节点的实际 IP（10.11.27.171）
        preferIpAddress: true
        # 服务端口（若未指定，默认使用应用启动端口，如 8080，确保端口未被占用）
        port: 8080
        
systemctl restart bk-ci-vteam.service
```

#### 9.mongod连接超时，副本集配置不匹配

```bash
# mongod配置的一个是副本集连接，但是主节点没有副本集

# 快速解决
vim /data/bkee/etc/ci/application-cteam.yml
data:
    mongodb:
      uri: mongodb://ctest:ctest@10.11.27.174:27017/db_devops_ci_ctest?maxPoolSize=50&slaveOk=true&safe=true&w=1&wtimeoutMS=2000
      # uri: mongodb://ctest:ctest@10.11.27.174:27017/db_devops_ci_ctest?maxPoolSize=50&replicaSet=rs0&slaveOk=true&safe=true&w=1&wtimeoutMS=2000
      field-naming-strategy: org.springframework.data.mapping.model.SnakeCaseFieldNamingStrategy
      auto-index-creation: true
      
# 删除replicaset=rs0或者是去主节点上初始化副本集rs0
```

#### 10.批量启动和停止服务

```bash
[Unit]
# 关键配置：将服务与目标关联
PartOf=bk-ci.target
# 指定服务在目标启动时自动启动
WantedBy=bk-ci.target


systemctl stop bk-ci.service  # 由于partof属性，相关联的服务也都停止
systemctl start bk-ci.service # 由于wantedby属性，相关联的服务也都启动
```





